<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accesorios RD - Control Total</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --rd-primary: #0984e3; --rd-success: #00b894; --rd-dark: #2d3436; --wa-color: #25D366; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', system-ui, sans-serif; }
        .navbar { background-color: var(--rd-dark); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .img-preview { width: 45px; height: 45px; object-fit: cover; border-radius: 8px; background: #eee; }
        .stat-card { background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); color: white; }
        .top-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; border-left: 4px solid var(--rd-success); }
        .filter-group { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-filter { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 10px; padding: 4px 8px; border-radius: 20px; text-transform: uppercase; transition: 0.3s; }
        .btn-filter.active { background: var(--rd-success); border-color: var(--rd-success); font-weight: bold; }
        .btn-download-report { background: #ff7675; border: none; color: white; font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        #img-edit-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; border: 2px solid #ddd; display: none; margin: 0 auto; }
    </style>
</head>
<body>

<nav class="navbar px-4 py-3 mb-4">
    <div class="container-fluid d-flex justify-content-between">
        <h3 class="m-0">Accesorios RD âŒš</h3>
        <span id="cloud-status" class="badge bg-danger">Conectando...</span>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-lg-7">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="m-0 fw-bold">Inventario Real</h5>
                    <button class="btn btn-primary btn-sm rounded-pill" onclick="abrirModalProd()">+ Nuevo Producto</button>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle text-center">
                        <thead>
                            <tr><th>Imagen</th><th>Nombre</th><th>Venta</th><th>Stock</th><th>AcciÃ³n</th></tr>
                        </thead>
                        <tbody id="tabla-inventario"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card stat-card p-4 mb-3">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <h6 class="text-uppercase small opacity-75">Ganancia Real</h6>
                    <button class="btn-download-report" onclick="descargarReporteMensual()">â¬‡ Reporte PDF</button>
                </div>
                <h2 id="ganancia-total" class="mb-3">RD$ 0.00</h2>
                
                <div class="filter-group">
                    <button class="btn btn-filter active" onclick="filtrarGanancia('total', this)">Todo</button>
                    <button class="btn btn-filter" onclick="filtrarGanancia('hoy', this)">Hoy</button>
                    <button class="btn btn-filter" onclick="filtrarGanancia('semana', this)">Semana</button>
                    <button class="btn btn-filter" onclick="filtrarGanancia('mes', this)">Mes</button>
                    <button class="btn btn-filter" onclick="filtrarGanancia('ano', this)">AÃ±o</button>
                </div>
                <hr>
                <canvas id="graficaVentas" height="120"></canvas>
            </div>

            <div class="card stat-card p-4" style="background: var(--rd-dark) !important;">
                <h6 class="text-uppercase small opacity-75 mb-3">ðŸ”¥ MÃ¡s Vendidos del Mes</h6>
                <div id="top-productos-lista"></div>
            </div>

            <div class="card p-4 border-top border-primary border-4 mt-3">
                <h5 class="mb-3 text-primary">Generar Factura</h5>
                <div class="mb-3">
                    <label class="small fw-bold">Producto</label>
                    <select id="select-producto" class="form-select"></select>
                </div>
                <div class="row mb-3">
                    <div class="col-7"><input type="text" id="cliente-nombre" class="form-control" placeholder="Cliente"></div>
                    <div class="col-5"><input type="text" id="cliente-tel" class="form-control" placeholder="WhatsApp"></div>
                </div>
                <div class="row mb-3">
                    <div class="col"><input type="number" id="input-cantidad" class="form-control" value="1" min="1"></div>
                    <div class="col"><input type="number" id="input-km" class="form-control" placeholder="Distancia KM"></div>
                </div>
                <button class="btn btn-dark w-100 py-3 fw-bold" onclick="procesarVenta()">ðŸš€ REGISTRAR VENTA</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalProducto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tituloModal">Gestionar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <input type="hidden" id="edit-id">
                <img id="img-edit-preview" src="">
                <input type="text" id="add-nombre" class="form-control mb-2" placeholder="Nombre del Producto">
                <div class="row mb-2">
                    <div class="col"><input type="number" id="add-costo" class="form-control" placeholder="Costo RD$"></div>
                    <div class="col"><input type="number" id="add-precio" class="form-control" placeholder="Venta RD$"></div>
                </div>
                <input type="number" id="add-stock" class="form-control mb-2" placeholder="Cantidad en Stock">
                <input type="file" id="add-img-file" class="form-control" accept="image/*" onchange="previewImagen(event)">
            </div>
            <div class="modal-footer flex-column">
                <button class="btn btn-primary w-100 mb-2" onclick="guardarProducto()">Guardar Cambios</button>
                <button id="btn-eliminar-prod" class="btn btn-outline-danger btn-sm w-100" style="display: none;" onclick="eliminarProducto()">Eliminar de Inventario</button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDXwadEbd3tGZ62d8l2JER3OotlFqXs4yk",
        authDomain: "accesoriosrd-c346b.firebaseapp.com",
        databaseURL: "https://accesoriosrd-c346b-default-rtdb.firebaseio.com",
        projectId: "accesoriosrd-c346b",
        storageBucket: "accesoriosrd-c346b.firebasestorage.app",
        messagingSenderId: "488599788461",
        appId: "1:488599788461:web:426519ced50221136b1f24"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let inventario = [], ventas = [], miGrafico, filtroActual = 'total', base64Img = "";
    let modalProd;

    window.onload = () => {
        modalProd = new bootstrap.Modal(document.getElementById('modalProducto'));
    };

    db.ref('/').on('value', (snap) => {
        const data = snap.val();
        if (data) {
            inventario = data.inventario ? Object.keys(data.inventario).map(k => ({id:k, ...data.inventario[k]})) : [];
            ventas = data.ventas ? Object.values(data.ventas) : [];
            render();
            actualizarTopProductos();
            document.getElementById('cloud-status').className = "badge bg-success";
            document.getElementById('cloud-status').innerText = "Conectado";
        }
    });

    function abrirModalProd() {
        document.getElementById('tituloModal').innerText = "Nuevo Producto";
        document.getElementById('edit-id').value = "";
        document.getElementById('add-nombre').value = "";
        document.getElementById('add-costo').value = "";
        document.getElementById('add-precio').value = "";
        document.getElementById('add-stock').value = "";
        document.getElementById('img-edit-preview').style.display = "none";
        document.getElementById('btn-eliminar-prod').style.display = "none";
        base64Img = "";
        modalProd.show();
    }

    function previewImagen(e) {
        const reader = new FileReader();
        reader.onload = () => {
            base64Img = reader.result;
            const p = document.getElementById('img-edit-preview');
            p.src = base64Img;
            p.style.display = "block";
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function guardarProducto() {
        const id = document.getElementById('edit-id').value;
        const nombre = document.getElementById('add-nombre').value;
        const costo = parseFloat(document.getElementById('add-costo').value) || 0;
        const precio = parseFloat(document.getElementById('add-precio').value) || 0;
        const stock = parseInt(document.getElementById('add-stock').value) || 0;
        if(!nombre) return alert("Escribe el nombre");
        const p = { nombre, costo, precio, stock, img: base64Img };
        const ref = id ? db.ref('inventario/' + id) : db.ref('inventario').push();
        ref.set(p).then(() => modalProd.hide());
    }

    function editarProducto(id) {
        const p = inventario.find(x => x.id === id);
        document.getElementById('tituloModal').innerText = "Editar Producto";
        document.getElementById('edit-id').value = p.id;
        document.getElementById('add-nombre').value = p.nombre;
        document.getElementById('add-costo').value = p.costo;
        document.getElementById('add-precio').value = p.precio;
        document.getElementById('add-stock').value = p.stock;
        document.getElementById('btn-eliminar-prod').style.display = "block";
        if(p.img) {
            const prev = document.getElementById('img-edit-preview');
            prev.src = p.img;
            prev.style.display = "block";
            base64Img = p.img;
        } else {
            document.getElementById('img-edit-preview').style.display = "none";
            base64Img = "";
        }
        modalProd.show();
    }

    // --- NUEVA FUNCIÃ“N: ELIMINAR PRODUCTO ---
    function eliminarProducto() {
        const id = document.getElementById('edit-id').value;
        if(!id) return;

        Swal.fire({
            title: 'Â¿Eliminar producto?',
            text: "Esta acciÃ³n no se puede deshacer.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#2d3436',
            confirmButtonText: 'SÃ­, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                db.ref('inventario/' + id).remove().then(() => {
                    modalProd.hide();
                    Swal.fire('Eliminado', 'El producto ha sido borrado.', 'success');
                });
            }
        });
    }

    function render() {
        const tabla = document.getElementById('tabla-inventario');
        const select = document.getElementById('select-producto');
        tabla.innerHTML = ''; select.innerHTML = '<option value="">Seleccione...</option>';
        inventario.forEach((p, i) => {
            tabla.innerHTML += `<tr>
                <td><img src="${p.img||'https://via.placeholder.com/50'}" class="img-preview"></td>
                <td>${p.nombre}</td>
                <td>RD$ ${p.precio}</td>
                <td><span class="badge ${p.stock<3?'bg-danger':'bg-success'}">${p.stock}</span></td>
                <td><button class="btn btn-sm btn-outline-primary" onclick="editarProducto('${p.id}')">Editar</button></td>
            </tr>`;
            select.innerHTML += `<option value="${i}">${p.nombre} (Stock: ${p.stock})</option>`;
        });
        actualizarDash();
    }

    function filtrarGanancia(per, btn) {
        filtroActual = per;
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        actualizarDash();
    }

    function actualizarDash() {
        const ahora = new Date();
        const filtradas = ventas.filter(v => {
            const fv = new Date(v.fecha);
            const diff = (ahora - fv) / (1000*3600*24);
            if(filtroActual==='hoy') return fv.toDateString()===ahora.toDateString();
            if(filtroActual==='semana') return diff<=7;
            if(filtroActual==='mes') return diff<=30;
            if(filtroActual==='ano') return diff<=365;
            return true;
        });
        const suma = filtradas.reduce((acc,v) => acc + v.ganancia, 0);
        document.getElementById('ganancia-total').innerText = `RD$ ${suma.toLocaleString()}`;
        const ctx = document.getElementById('graficaVentas').getContext('2d');
        const d = new Array(12).fill(0);
        ventas.forEach(v => d[new Date(v.fecha).getMonth()] += v.ganancia);
        if(miGrafico) miGrafico.destroy();
        miGrafico = new Chart(ctx, { type: 'line', data: { labels: ["E","F","M","A","M","J","J","A","S","O","N","D"], datasets: [{ data: d, borderColor: '#00b894', tension: 0.3, fill: true, backgroundColor: 'rgba(0,184,148,0.1)' }] }, options: { plugins: { legend: false }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#fff', font: {size: 9} } } } } });
    }

    function actualizarTopProductos() {
        const listaTop = document.getElementById('top-productos-lista');
        const ahora = new Date();
        const ventasMes = ventas.filter(v => new Date(v.fecha).getMonth() === ahora.getMonth());
        const resumen = {};
        ventasMes.forEach(v => {
            if (!resumen[v.producto]) resumen[v.producto] = { ganancia: 0, cant: 0 };
            resumen[v.producto].ganancia += v.ganancia;
            resumen[v.producto].cant++;
        });
        const topArray = Object.entries(resumen).sort((a,b) => b[1].ganancia - a[1].ganancia).slice(0, 5);
        listaTop.innerHTML = topArray.map((p, i) => `
            <div class="top-item">
                <span class="top-item-name">${i+1}. ${p[0]}</span>
                <span class="fw-bold text-success">RD$ ${p[1].ganancia.toLocaleString()}</span>
            </div>
        `).join('');
    }

    function procesarVenta() {
        const idx = document.getElementById('select-producto').value;
        const cant = parseInt(document.getElementById('input-cantidad').value);
        const cliente = document.getElementById('cliente-nombre').value || "Cliente General";
        const telefono = document.getElementById('cliente-tel').value;
        const km = document.getElementById('input-km').value || "0";

        if(idx==="" || isNaN(cant)) return Swal.fire("Error", "Selecciona producto y cantidad", "error");
        
        const p = inventario[idx];
        if(p.stock < cant) return Swal.fire("Sin Stock", "No hay suficiente mercancÃ­a", "warning");

        const gananciaReal = (p.precio - p.costo) * cant;
        const totalVenta = p.precio * cant;

        db.ref('inventario/'+p.id).update({ stock: p.stock - cant }).then(() => {
            db.ref('ventas').push({ 
                producto: p.nombre, 
                ganancia: gananciaReal, 
                fecha: new Date().toISOString(), 
                cliente: cliente 
            });

            Swal.fire({
                title: 'Â¡Venta Exitosa!',
                text: "Â¿CÃ³mo deseas entregar el comprobante?",
                icon: 'success',
                showCancelButton: true,
                confirmButtonColor: '#25D366',
                cancelButtonColor: '#2d3436',
                confirmButtonText: 'WhatsApp ðŸ“±',
                cancelButtonText: 'PDF Profesional ðŸ“„',
                reverseButtons: true
            }).then((result) => {
                const fechaActual = new Date().toLocaleString('es-DO');
                const numFactura = Math.floor(1000 + Math.random() * 9000);

                if (result.isConfirmed) {
                    const mensaje = `*ACCESORIOS RD* âŒš%0A*Factura # ${numFactura}*%0A---%0A*Cliente:* ${cliente}%0A*Producto:* ${p.nombre}%0A*Cantidad:* ${cant}%0A*Total:* RD$ ${totalVenta.toLocaleString()}%0A*Fecha:* ${fechaActual}%0A---%0AÂ¡Gracias por su preferencia!`;
                    window.open(`https://wa.me/${telefono}?text=${mensaje}`, '_blank');
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ unit: 'mm', format: [80, 150] });
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(14);
                    doc.text("ACCESORIOS RD", 40, 12, {align: 'center'});
                    doc.setFontSize(8);
                    doc.setFont("helvetica", "normal");
                    doc.text("Elegancia y Estilo en tus manos", 40, 17, {align: 'center'});
                    doc.line(10, 20, 70, 20);
                    doc.setFont("helvetica", "bold");
                    doc.text(`FACTURA: #${numFactura}`, 10, 28);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Fecha: ${fechaActual}`, 10, 33);
                    doc.text(`Cliente: ${cliente}`, 10, 38);
                    doc.autoTable({
                        startY: 42,
                        margin: { left: 5, right: 5 },
                        head: [['Cant', 'DescripciÃ³n', 'Subtotal']],
                        body: [[cant, p.nombre, `RD$ ${totalVenta.toLocaleString()}`]],
                        theme: 'plain',
                        headStyles: { fontSize: 8, fontStyle: 'bold', fillColor: [240, 240, 240] },
                        styles: { fontSize: 8 },
                        columnStyles: { 2: { halign: 'right' } }
                    });
                    const finalY = doc.lastAutoTable.finalY + 10;
                    doc.line(40, finalY - 5, 75, finalY - 5);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text("TOTAL RD$", 40, finalY);
                    doc.text(`${totalVenta.toLocaleString()}`, 75, finalY, { align: 'right' });
                    doc.save(`Factura_${numFactura}_${cliente}.pdf`);
                }
            });
        });
    }

    function descargarReporteMensual() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("REPORTE DE VENTAS - ACCESORIOS RD", 10, 15);
        doc.autoTable({
            startY: 30,
            head: [['Fecha', 'Producto', 'Ganancia (RD$)']],
            body: ventas.map(v => [new Date(v.fecha).toLocaleDateString(), v.producto, v.ganancia.toLocaleString()]),
            headStyles: { fillColor: [45, 52, 54] }
        });
        doc.save("Reporte_Mensual_AccesoriosRD.pdf");
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
